services:
  # Original build (downloads sources each time)
  ort-rknpu-build:
    build:
      context: .
      dockerfile: Dockerfile.rk3588
      platforms:
        - linux/arm64/v8
    container_name: ort-rknpu-build
    volumes:
      - ./out:/out

  # Optimized build using local sources (much faster)
  ort-rknpu-local:
    build:
      context: .
      dockerfile: Dockerfile.rk3588.local
      platforms:
        - linux/arm64/v8
    container_name: ort-rknpu-local
    volumes:
      - ./out:/out
      - ccache:/ccache

  # Ultra-optimized: volume-mount builder (zero build context)
  ort-rknpu-volume:
    build:
      context: .
      dockerfile: Dockerfile.rk3588.build
      target: builder
      platforms:
        - linux/arm64/v8
    container_name: ort-rknpu-volume
    volumes:
      # Mount sources read-only from host
      - ./sources/rknpu_ddk:/workspace/rknpu_ddk:ro
      - ./sources/onnxruntime:/workspace/onnxruntime
      # Build output (mounted to /out, used via OUTPUT_DIR)
      - ./out:/out
      # Persistent ccache
      - ccache:/ccache
    environment:
      OUTPUT_DIR: /out
      CCACHE_DIR: /ccache

volumes:
  ccache:
    driver: local
